<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width"/>
    <title>设备录像、人像详情</title>
    <link href="../../Content/css/framework-font.css" rel="stylesheet"/>
    <link href="../../Content/css/framework-theme.css" rel="stylesheet"/>
    <script src="../../Content/js/jquery/jquery-2.1.1.min.js"></script>
    <script src="../../Content/js/bootstrap/bootstrap.js"></script>
    <link href="../../Content/js/bootstrap/bootstrap.min.css" rel="stylesheet"/>
    <script src="../../Content/js/jqgrid/jqgrid.min.js"></script>
    <link href="../../Content/js/jqgrid/jqgrid.css" rel="stylesheet"/>
    <link href="../../Content/js/select2/select2.min.css" rel="stylesheet"/>
    <script src="../../Content/js/select2/select2.min.js"></script>
    <link href="../../Content/js/wizard/wizard.css" rel="stylesheet"/>
    <script src="../../Content/js/wizard/wizard.js"></script>
    <script src="../../Content/js/jqgrid/grid.locale-cn.js"></script>
    <link href="../../Content/css/framework-ui.css" rel="stylesheet"/>
    <script src="../../Content/js/framework-ui.js"></script>
    <style>
        .cbox{
            margin-top: 10px;
        }

        td[aria-describedby="gridList_cb"]{
            vertical-align: middle;
        }
        .ca{
            color: #1890FF;
        }
    </style>
    <script>
        $(function () {
            var selectedIds = [];

            var deviceNo = $.request("deviceNo");
            var type = $.request("type");
            var deviceName = queryChiniseParamsByUrl("deviceName");
            if(deviceName){
                deviceName = decodeURI(deviceName)
            }

            if(type){
                $("#type").val(type)
            }

            //查询
            $("#btn_search").click(function () {
                $("#gridList").jqGrid('setGridParam', {
                    postData: {
                        keyword: $("#txt_keyword").val(),
                        avitype:$("#type").val()
                    }
                }).trigger('reloadGrid');
            });

            //重置
            $("#btn_reset").click(function () {
                $("#txt_keyword").val("");
                $("#type").val("");
                $("#gridList").clearGridData();
                $("#gridList").jqGrid('setGridParam', {
                    page:1,//回到第一页
                    postData: {
                        keyword: $("#txt_keyword").val(),
                        avitype:$("#type").val()
                    }
                }).trigger('reloadGrid');
            });

            $("#btn_delete").click(function () {
                if(selectedIds && selectedIds.length > 0){
                    deleteAvi(selectedIds.join(","))
                }else {
                    $.modalMsg("请选择要删除的项", "warning");
                }
            });


            //默认加载数据
            init();

            function queryChiniseParamsByUrl(name) {
                var search = location.search.slice(1);
                var arr = search.split("&");
                for (var i = 0; i < arr.length; i++) {
                    var ar = arr[i].split("=");
                    if (ar[0] == name) {
                        if (unescape(ar[1]) == 'undefined') {
                            return "";
                        } else {
                            return ar[1];
                        }
                    }
                }
                return "";
            }

            /**
             * 加载数据
             */
            function init() {
                $("#gridList").jqGrid({
                    url: $.sysStaticData().urlExt + "/aviInfo/queryAviList",
                    datatype: "json",
                    mtype: "POST",
                    height: $(window).height() - 128,
                    postData: {
                        keyword: $("#txt_keyword").val(),
                        deviceNo:deviceNo,
                        avitype:$("#type").val()
                    },
                    jsonReader: {
                        total: "totalPage",
                        page: "currentPage",
                        records: "totalResult",
                        root: "list",
                        id: "id"
                    },
                    rownumbers:true,
                    autowidth: true,
                    colNames: ["设备描述", "内容名称", "类型","最新更新", "操作"],
                    colModel: [

                        {name: 'deviceName', align: 'left'},
                        {
                            name: 'avi_name', align: 'center',
                            formatter: function (cellvalue) {
                                return "<a class=\"fa ca aviname\"'>"+cellvalue+"</a>";
                            }
                        },
                        {
                            name: 'avi_type', align: 'center',
                            formatter: function (cellvalue) {
                               switch (cellvalue){
                                   case 1:
                                       return "人像";
                                   case 2:
                                       return "录像";
                                   case 3:
                                       return "签字";
                               }
                            }
                        },
                        {
                            name: 'creatorTime', align: 'center',
                            formatter: function (value, row, index) {
                                return $.changeDateFormat(value).DateExt;
                            }
                        },
                        {
                            name: 'avi_type', align: 'center',
                            formatter: function (value, row, index) {
                                return "<a class=\"fa ca btn-look\" data-type='"+value+"'>查看</a>" + "<a class=\"fa ca btn-del\" style='margin-left: 10px;'>删除</a>";
                            }
                        }

                    ],
                    pager: "#gridPager",
                    sortname: 'sortCode',
                    viewrecords: true,
                    gridComplete:function () {
                        $("td[aria-describedby='gridList_deviceName']").text(deviceName);
                        $(".btn-del").click(function () {
                            var id = $(this).parents("tr").attr("id");
                            deleteAvi(id);
                        });

                        $(".btn-look").click(function () {
                            var name = $(this).parents("tr").find(".aviname").text();
                            var type = $(this).data("type");
                            lookAvi(name,type);
                        })
                    }
                    ,
                    multiselect:true,
                    onSelectAll:function (aRowids, status) {
                        selectedIds = null;
                        if(status){
                            selectedIds = aRowids;
                        }else {
                            selectedIds = [];
                        }
                    },
                    onSelectRow:function (rowid, status) {
                        if(status){
                            addNotRepeatIdToArray(rowid,selectedIds);
                        }else {
                            deleteIdFromArray(rowid,selectedIds);
                        }
                        console.log(selectedIds)
                    }
                });
                $("#gridList").jqGrid('setLabel',0, '序号');
            }

            function lookAvi(name,type) {
                $.modalOpen({
                    id: "preview",
                    title: "多媒体预览",
                    url: $.sysStaticData().urlExt + "/ContentManage/VideoSigin/MediaPreview.html?name="+name+"&type="+type,
                    width: "900px",
                    height: "860px",
                    btn: null,
                });
            }


            /**
             * 删除avi
             * @param ids 可以是单个id 也可以是id集合
             */
            function deleteAvi(ids) {
                $.deleteForm({
                    url:$.sysStaticData().urlExt+"/aviInfo/deleteAvi",
                    param:{
                        id:ids
                    },
                    success:function (data) {
                        selectedIds = [];
                        var idsArray = ids.split(",");
                        $.each(idsArray,function (index, id) {
                            $("#gridList").delRowData(id);
                        })
                    }
                })
            }


            /**
             * 向数组中添加不重复的string类型的数据
             * @param str
             * @param arr
             */
            function addNotRepeatIdToArray(str, arr) {
                if(arr.indexOf(str) == -1){
                    arr.push(str)
                }
            }

            /**
             * 删除数组中的某个元素
             * @param str
             * @param arr
             */
            function deleteIdFromArray(str, arr) {
                var index = arr.indexOf(str);
                if (index > -1) {
                    arr.splice(index, 1);
                }

            }

        });





    </script>
</head>
<body>
<div class="topPanel">
    <div class="toolbar">
        <div class="btn-group">
            <a class="btn btn-primary" onclick="$.reload()"><span class="glyphicon glyphicon-refresh"></span></a>
        </div>
        <!-- <div class="btn-group">
             <a id="NF-add" authorize="yes" class="btn btn-primary dropdown-text" onclick="btn_add()"><i class="fa fa-plus"></i>新增公告</a>
         </div>
         <div class="operate">
             <ul class="nav nav-pills">
                 <li class="first">已选中<span>1</span>项</li>
                 <li><a id="NF-edit" authorize="yes" onclick="btn_edit()"><i class="fa fa-pencil-square-o"></i>查看录像列表</a></li>
                 <li><a id="NF-delete" authorize="yes" onclick="btn_delete()"><i class="fa fa-trash-o"></i>查看签字人像列表</a></li>
                 <li><a id="NF-Details" authorize="yes" onclick="btn_details()"><i class="fa fa-search-plus"></i>查看公告</a></li>
                 <li><a id="NF-Details" authorize="yes" onclick="btn_publish()"><i class="fa fa-search-plus"></i>发布公告</a></li>
             </ul>
             <a href="javascript:;" class="close"></a>
         </div>-->
        <!-- <script>//$('.toolbar').authorizeButton()</script>-->
    </div>
    <div class="search">
        <table>
            <tr>
                <th class="formTitle type" style="padding:0px 10px 0px 20px">类型</th>
                <td class="formValue type" colspan="3">
                    <div id="txt_condition_state" class="btn-group">
                        <select id="type" name="type" class="form-control required" style="height:20px">
                            <option value="" selected>全部</option>
                            <option value="1">人像</option>
                            <option value="2">录像</option>
                            <option value="3">签字</option>
                        </select>
                    </div>
                </td>
                <th class="formTitle" style="padding-left: 50px;"><span>内容名称</span></th>
                <td>
                    <div class="input-group">
                        <input id="txt_keyword" type="text" class="form-control" placeholder="请输入"
                               style="width: 200px;margin-left: 10px;">
                        <span class="input-group-btn">
                            <button id="btn_search" type="button" class="btn  btn-primary"><i class="fa fa-search"></i></button>
                        </span>
                    </div>
                </td>
                <td>
                    <button id="btn_reset" type="button" class="btn  btn-default" style="margin-left: 10px;">重置</button>
                </td>
                <td>
                    <button id="btn_delete" type="button" class="btn  btn-danger" style="margin-left: 10px;">批量删除</button>
                </td>
            </tr>
        </table>
    </div>
</div>
<div></div>
<div class="gridPanel">
    <table id="gridList"></table>
    <div id="gridPager"></div>
</div>
</body>
</html>